name: actions
on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  # schedule:
  #   - cron: 0 22 */3 * *

env:
  REPO_URL: https://github.com/zhx47/bakup.git
  REPO_BRANCH: master
  IMAGE_NAME: jd_h5st_server
  REGISTRY: youfak

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨æƒ…å†µ
        run: |
          echo "è­¦å‘Šâš "
          echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
          echo -e "å·²çŸ¥CPUå‹å·(é™åº): 7763ï¼Œ8370Cï¼Œ8272CLï¼Œ8171Mï¼ŒE5-2673\n"
          echo "--------------------------CPUä¿¡æ¯--------------------------"
          echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
          echo "CPUæ ¸å¿ƒæ•°é‡: $(nproc)"
          echo -e "CPUå‹å·ä¿¡æ¯:$(cat /proc/cpuinfo | grep -m1 name | awk -F: '{print $2}')\n"
          echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
          echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯:"
          echo -e "$(sudo lshw -short -C memory | grep GiB)\n"
          echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
          echo "ç¡¬ç›˜æ•°é‡: $(ls /dev/sd* | grep -v [1-9] | wc -l)" && df -hT
      - name: ä¸‹è½½å›ºä»¶æºç 
        run: |
          git clone ${{ env.REPO_URL }} --branch ${{ env.REPO_BRANCH }} --depth 1
          ls -l bakup
      - name: è¿›å…¥æºç ç›®å½•
        run: | 
          cd bakup
          ls -l
          
      - name: ä¿®æ”¹Dockerfile
        run: |
          sed -i 's|curl -L.*githubusercontent.com|curl -L https://gist.githubusercontent.com|g' bakup/Dockerfile
          cat bakup/Dockerfile
          
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ç™»å½•åˆ°DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        id: docker_build
        uses: docker/build-push-action@v3
        with:
          context: bakup
          file: bakup/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: å‘é€Telegramé€šçŸ¥
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            æ„å»ºç»“æœé€šçŸ¥
            âš¡ æ„å»ºçŠ¶æ€: ${{ job.status }}
            ğŸ“¦ ä»“åº“: ${{ github.repository }}
            ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}
            ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
            
            ğŸ”„ å·¥ä½œæµ: ${{ github.workflow }}
            ğŸ“‹ è¿è¡Œç¼–å·: #${{ github.run_number }}
            
            ğŸ” è¯¦ç»†ä¿¡æ¯: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: å‘é€é‚®ä»¶é€šçŸ¥
        if: always()
        uses: dawidd6/action-send-mail@v4
        with:
          server_address: smtp.163.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ã€${{ job.status }}ã€‘Dockeræ„å»ºé€šçŸ¥ - ${{ github.repository }}
          body: |
            æ„å»ºç»“æœé€šçŸ¥
            
            âš¡ æ„å»ºçŠ¶æ€: ${{ job.status }}
            ğŸ“¦ ä»“åº“: ${{ github.repository }}
            ğŸŒ¿ åˆ†æ”¯: ${{ github.ref }}
            ğŸ’¬ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
            
            ğŸ”„ å·¥ä½œæµ: ${{ github.workflow }}
            ğŸ“‹ è¿è¡Œç¼–å·: #${{ github.run_number }}
            
            ğŸ” è¯¦ç»†ä¿¡æ¯: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿å›å¤ã€‚
          to: ${{ secrets.EMAIL_TO }}
          from: GitHub Actions <${{ secrets.EMAIL_USERNAME }}@163.com>
          content_type: text/plain
